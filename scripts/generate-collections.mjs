import fs from 'node:fs/promises';
import path from 'node:path';
import YAML from 'yaml';

const ROOT = process.cwd();
const CONFIG_PATH = process.argv[2] ?? 'static/admin/config.yml';
const OUT_PATH = 'src/lib/generated/collections.ts';

function extFromFormat(col) {
	// Your config uses "format: frontmatter" => markdown with frontmatter
	// Default to md unless you later add an explicit extension in config.
	return col.extension ? String(col.extension).replace(/^\./, '') : 'md';
}

function fileFormat(filePath) {
	const ext = filePath.split('.').pop()?.toLowerCase() ?? '';
	if (ext === 'json') return 'json';
	if (ext === 'yaml' || ext === 'yml') return 'yaml';
	return 'markdown';
}

async function main() {
	const configRaw = await fs.readFile(path.resolve(ROOT, CONFIG_PATH), 'utf8');
	const config = YAML.parse(configRaw);

	const cols = Array.isArray(config?.collections) ? config.collections : [];

	const entries = cols
		.filter((c) => c?.name)
		.map((c) => {
			if (c.folder) {
				return [
					c.name,
					{
						name: c.name,
						kind: 'folder',
						folder: c.folder,
						format: 'markdown',
						extension: extFromFormat(c)
					}
				];
			}

			if (Array.isArray(c.files)) {
				return [
					c.name,
					{
						name: c.name,
						kind: 'files',
						files: c.files.map((f) => ({
							name: f.name,
							file: f.file,
							format: fileFormat(f.file)
						}))
					}
				];
			}

			return null;
		})
		.filter(Boolean);

	const obj = Object.fromEntries(entries);

	const out = `/* 
 * AUTO-GENERATED FILE — DO NOT EDIT.
 * Generated by scripts/generate-collections.mjs from ${CONFIG_PATH}
 */

export type CollectionFormat = 'json' | 'yaml' | 'markdown' | 'unknown';
export type CollectionKind = 'folder' | 'files';

export type FolderCollectionDef = {
\tname: string;
\tkind: 'folder';
\tfolder: string;
\tformat: CollectionFormat;
\textension: string;
};

export type FilesCollectionItem = {
\tname: string;
\tfile: string;
\tformat: CollectionFormat;
};

export type FilesCollectionDef = {
\tname: string;
\tkind: 'files';
\tfiles: FilesCollectionItem[];
};

export type CollectionDef = FolderCollectionDef | FilesCollectionDef;

export const collections = ${JSON.stringify(obj, null, 2)} as const;

export type CollectionName = keyof typeof collections;
`;

	await fs.mkdir(path.resolve(ROOT, path.dirname(OUT_PATH)), { recursive: true });
	await fs.writeFile(path.resolve(ROOT, OUT_PATH), out, 'utf8');
	console.log(`✅ Wrote ${OUT_PATH}`);
}

main().catch((err) => {
	console.error(err);
	process.exit(1);
});
